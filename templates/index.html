<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .file-upload-area {
            border: 2px dashed #e5e7eb;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }
        .file-upload-area:hover {
            border-color: #3b82f6;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.1);
        }
        .file-upload-area.dragover {
            border-color: #1d4ed8;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(59, 130, 246, 0.2);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .chart-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .chart-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.12);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">
    <div class="container mx-auto px-4 py-12">
        <!-- Header -->
        <div class="text-center mb-16">
            <div class="gradient-bg text-white py-16 px-8 rounded-3xl mb-8 card-shadow">
                <h1 class="text-5xl font-bold mb-6">Data Analyzer</h1>
                <p class="text-xl opacity-90 max-w-2xl mx-auto leading-relaxed">Transform your data into stunning visualizations with our modern analytics platform</p>
            </div>
        </div>

        <!-- Upload Section -->
        <div id="upload-section" class="max-w-3xl mx-auto mb-16">
            <div class="bg-white rounded-2xl p-8 card-shadow">
                <div class="file-upload-area rounded-2xl p-16 text-center cursor-pointer" id="upload-area">
                    <div class="mb-6">
                        <svg class="mx-auto h-20 w-20 text-blue-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold mb-3 text-gray-800">Drop your file here</h3>
                    <p class="text-gray-600 mb-6 text-lg">or click to browse your files</p>
                    <div class="inline-flex items-center px-4 py-2 bg-blue-50 rounded-full">
                        <span class="text-sm text-blue-600 font-medium">Supports CSV, XLS, XLSX files (max 16MB)</span>
                    </div>
                    <input type="file" id="file-input" class="hidden" accept=".csv,.xlsx,.xls">
                </div>
                
                <!-- Upload Button -->
                <div class="text-center mt-8">
                    <button id="upload-btn" class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-10 py-4 rounded-xl font-semibold text-lg hover:from-blue-700 hover:to-purple-700 transform hover:scale-105 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none" disabled>
                        Upload & Analyze Data
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div id="loading" class="hidden text-center py-16">
            <div class="bg-white rounded-2xl p-12 card-shadow max-w-md mx-auto">
                <div class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-blue-200 border-t-blue-600"></div>
                <p class="mt-6 text-gray-700 text-lg font-medium">Processing your data...</p>
                <p class="mt-2 text-gray-500">This may take a few moments</p>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="hidden">
            <!-- Dataset Info -->
            <div class="bg-white rounded-2xl p-8 mb-12 card-shadow">
                <h2 class="text-3xl font-bold mb-8 text-gray-800 text-center">Dataset Overview</h2>
                <div id="dataset-info" class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
                    <!-- Info will be populated here -->
                </div>
                
                <!-- Data Preview -->
                <div class="mt-8">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">Data Preview</h3>
                    <div class="overflow-x-auto bg-gray-50 rounded-xl border border-gray-200">
                        <div id="data-preview"></div>
                    </div>
                </div>
            </div>

            <!-- Chart Controls -->
            <div class="bg-white rounded-2xl p-8 mb-8 card-shadow">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Create Custom Chart</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Chart Type</label>
                        <select id="chart-type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="bar">Bar Chart</option>
                            <option value="line">Line Chart</option>
                            <option value="scatter">Scatter Plot</option>
                            <option value="pie">Pie Chart</option>
                            <option value="histogram">Histogram</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">X-Axis</label>
                        <select id="x-axis" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select column...</option>
                        </select>
                    </div>
                    <div id="y-axis-container">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Y-Axis</label>
                        <select id="y-axis" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select column...</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="create-chart-btn" class="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                            <span id="btn-text">Create Chart</span>
                            <span id="btn-loading" class="hidden flex items-center justify-center">
                                <svg class="animate-spin h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                Processing...
                            </span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chart Display -->
            <div class="space-y-8">
                <div class="chart-card p-8">
                    <div id="custom-chart" class="min-h-[400px] flex items-center justify-center text-gray-500">
                        Select chart type and columns to create your visualization
                    </div>
                    <div id="chart-loading" class="hidden min-h-[400px] flex flex-col items-center justify-center">
                        <div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-200 border-t-blue-600 mb-4"></div>
                        <p class="text-gray-600 text-lg font-medium">Creating your chart...</p>
                        <p class="text-gray-500 text-sm mt-2">Analyzing data and generating visualization</p>
                    </div>
                </div>
            </div>

            <!-- Reset Button -->
            <div class="text-center mt-16">
                <button id="reset-btn" class="bg-gradient-to-r from-gray-600 to-gray-700 text-white px-8 py-4 rounded-xl font-semibold text-lg hover:from-gray-700 hover:to-gray-800 transform hover:scale-105 transition-all duration-200">
                    Upload New File
                </button>
            </div>
        </div>
    </div>

    <script>
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        const uploadBtn = document.getElementById('upload-btn');
        const uploadSection = document.getElementById('upload-section');
        const loading = document.getElementById('loading');
        const resultsSection = document.getElementById('results-section');
        const resetBtn = document.getElementById('reset-btn');

        let selectedFile = null;

        // File upload area interactions
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        function handleFileSelect(file) {
            const allowedTypes = ['text/csv', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'];
            
            if (!allowedTypes.includes(file.type) && !file.name.match(/\.(csv|xlsx|xls)$/i)) {
                alert('Please select a CSV or Excel file');
                return;
            }

            if (file.size > 16 * 1024 * 1024) {
                alert('File size must be less than 16MB');
                return;
            }

            selectedFile = file;
            uploadBtn.disabled = false;
            uploadArea.innerHTML = `
                <div class="mb-6">
                    <svg class="mx-auto h-20 w-20 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <h3 class="text-2xl font-bold mb-3 text-gray-800">File Selected</h3>
                <p class="text-gray-700 text-lg font-medium">${file.name}</p>
                <div class="inline-flex items-center px-4 py-2 bg-green-50 rounded-full mt-4">
                    <span class="text-sm text-green-600 font-medium">${(file.size / 1024 / 1024).toFixed(2)} MB</span>
                </div>
            `;
        }

        uploadBtn.addEventListener('click', uploadFile);

        async function uploadFile() {
            if (!selectedFile) return;

            const formData = new FormData();
            formData.append('file', selectedFile);

            uploadSection.classList.add('hidden');
            loading.classList.remove('hidden');

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    displayResults(result);
                } else {
                    alert(result.error || 'Upload failed');
                    resetUpload();
                }
            } catch (error) {
                alert('Upload failed: ' + error.message);
                resetUpload();
            }

            loading.classList.add('hidden');
        }

        function displayResults(data) {
            // Display dataset info
            const infoDiv = document.getElementById('dataset-info');
            infoDiv.innerHTML = `
                <div class="text-center bg-blue-50 rounded-xl p-6">
                    <div class="text-4xl font-bold text-blue-600 mb-2">${data.info.rows}</div>
                    <div class="text-gray-700 font-medium">Rows</div>
                </div>
                <div class="text-center bg-purple-50 rounded-xl p-6">
                    <div class="text-4xl font-bold text-purple-600 mb-2">${data.info.columns}</div>
                    <div class="text-gray-700 font-medium">Columns</div>
                </div>
                <div class="text-center bg-green-50 rounded-xl p-6">
                    <div class="text-4xl font-bold text-green-600 mb-2">5</div>
                    <div class="text-gray-700 font-medium">Chart Types</div>
                </div>
            `;

            // Display data preview
            document.getElementById('data-preview').innerHTML = data.preview;

            // Populate column dropdowns
            const xAxisSelect = document.getElementById('x-axis');
            const yAxisSelect = document.getElementById('y-axis');
            
            xAxisSelect.innerHTML = '<option value="">Select column...</option>';
            yAxisSelect.innerHTML = '<option value="">Select column...</option>';
            
            data.info.column_names.forEach(col => {
                xAxisSelect.innerHTML += `<option value="${col}">${col}</option>`;
                yAxisSelect.innerHTML += `<option value="${col}">${col}</option>`;
            });

            resultsSection.classList.remove('hidden');
        }

        // Chart type change handler
        document.getElementById('chart-type').addEventListener('change', function() {
            const chartType = this.value;
            const yAxisContainer = document.getElementById('y-axis-container');
            
            if (chartType === 'pie' || chartType === 'histogram') {
                yAxisContainer.style.display = 'none';
            } else {
                yAxisContainer.style.display = 'block';
            }
        });

        // Create chart button handler
        document.getElementById('create-chart-btn').addEventListener('click', async function() {
            const chartType = document.getElementById('chart-type').value;
            const xColumn = document.getElementById('x-axis').value;
            const yColumn = document.getElementById('y-axis').value;
            
            if (!xColumn) {
                alert('Please select an X-axis column');
                return;
            }
            
            if ((chartType === 'bar' || chartType === 'line' || chartType === 'scatter') && !yColumn) {
                alert('Please select a Y-axis column for this chart type');
                return;
            }
            
            // Show loading states
            const btn = document.getElementById('create-chart-btn');
            const btnText = document.getElementById('btn-text');
            const btnLoading = document.getElementById('btn-loading');
            const chartDiv = document.getElementById('custom-chart');
            const chartLoading = document.getElementById('chart-loading');
            
            btn.disabled = true;
            btnText.classList.add('hidden');
            btnLoading.classList.remove('hidden');
            chartDiv.classList.add('hidden');
            chartLoading.classList.remove('hidden');
            
            try {
                const response = await fetch('/create_chart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        chart_type: chartType,
                        x_column: xColumn,
                        y_column: yColumn
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const chartData = JSON.parse(result.chart);
                    Plotly.newPlot(chartDiv, chartData.data, chartData.layout, {responsive: true});
                } else {
                    alert(result.error || 'Failed to create chart');
                }
            } catch (error) {
                alert('Error creating chart: ' + error.message);
            } finally {
                // Hide loading states
                btn.disabled = false;
                btnText.classList.remove('hidden');
                btnLoading.classList.add('hidden');
                chartLoading.classList.add('hidden');
                chartDiv.classList.remove('hidden');
            }
        });

        resetBtn.addEventListener('click', resetUpload);

        function resetUpload() {
            selectedFile = null;
            uploadBtn.disabled = true;
            uploadArea.innerHTML = `
                <div class="mb-6">
                    <svg class="mx-auto h-20 w-20 text-blue-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </div>
                <h3 class="text-2xl font-bold mb-3 text-gray-800">Drop your file here</h3>
                <p class="text-gray-600 mb-6 text-lg">or click to browse your files</p>
                <div class="inline-flex items-center px-4 py-2 bg-blue-50 rounded-full">
                    <span class="text-sm text-blue-600 font-medium">Supports CSV, XLS, XLSX files (max 16MB)</span>
                </div>
            `;
            
            uploadSection.classList.remove('hidden');
            resultsSection.classList.add('hidden');
            loading.classList.add('hidden');
            const customChart = document.getElementById('custom-chart');
            const chartLoading = document.getElementById('chart-loading');
            customChart.innerHTML = 'Select chart type and columns to create your visualization';
            customChart.classList.remove('hidden');
            chartLoading.classList.add('hidden');
        }
    </script>
</body>
</html>